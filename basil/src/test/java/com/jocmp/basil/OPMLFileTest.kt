package com.jocmp.basil

import org.junit.Rule
import org.junit.Test
import org.junit.rules.TemporaryFolder
import java.util.UUID
import kotlin.test.assertEquals

class OPMLFileTest {
    @JvmField
    @Rule
    val folder = TemporaryFolder()

    @Test
    fun opmlDocument_serializes() {
        val accountPath = folder.newFile().toURI()
        val account = Account(
            id = "777",
            path = accountPath.resolve("test.opml"),
        )

        account.folders.addAll(
            listOf(
                Folder(title = "Empty Folder"),
                Folder(
                    title = "Tech",
                    feeds = mutableListOf(
                        Feed(id = UUID.randomUUID().toString(), name = "The Verge"),
                        Feed(id = UUID.randomUUID().toString(), name = "Ars Technica")
                    )
                ),
                Folder(
                    title = "Programming",
                    feeds = mutableListOf(
                        Feed(id = UUID.randomUUID().toString(), name = "Android Weekly"),
                        Feed(id = UUID.randomUUID().toString(), name = "Ruby Weekly"),
                    )
                )
            )
        )

        account.feeds.addAll(
            listOf(
                Feed(id = UUID.randomUUID().toString(), name = "GamersNexus"),
                Feed(id = UUID.randomUUID().toString(), name = "9to5Google")
            )
        )

        val opmlFile = OPMLFile(
            path = accountPath,
            account = account
        )

        val documentSnapshot = """
        |<?xml version="1.0" encoding="UTF-8"?>
        |<!-- OPML generated by Basil Reader -->
        |<opml version="1.1">
        |  <head>
        |    <title>Test Display Name</title>
        |  </head>
        |  <body>
        |    <outline text="9to5Google" title="9to5Google" description="" type="rss" version="RSS" htmlUrl="" xmlUrl=""/>
        |    <outline text="GamersNexus" title="GamersNexus" description="" type="rss" version="RSS" htmlUrl="" xmlUrl=""/>
        |    <outline text="Empty Folder" title="Empty Folder"/>
        |    <outline text="Programming" title="Programming">
        |      <outline text="Android Weekly" title="Android Weekly" description="" type="rss" version="RSS" htmlUrl="" xmlUrl=""/>
        |      <outline text="Ruby Weekly" title="Ruby Weekly" description="" type="rss" version="RSS" htmlUrl="" xmlUrl=""/>
        |    </outline>
        |    <outline text="Tech" title="Tech">
        |      <outline text="The Verge" title="The Verge" description="" type="rss" version="RSS" htmlUrl="" xmlUrl=""/>
        |      <outline text="Ars Technica" title="Ars Technica" description="" type="rss" version="RSS" htmlUrl="" xmlUrl=""/>
        |    </outline>
        |  </body>
        |</opml>
        """.trimMargin()

        assertEquals(opmlFile.opmlDocument(), documentSnapshot)
    }
}
